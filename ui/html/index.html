<!DOCTYPE html>
<html data-bs-theme=”auto”>
<head>
    <title>ytdlp2STRM Settings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css" integrity="sha384-b6lVK+yci+bfDmaY1u0zE8YYJt0TZxLEAFyYSLHId4xoVvsrQu3INevFKo+Xir8e" crossorigin="anonymous">
    <link rel="stylesheet" href="/styles.css" crossorigin="anonymous">
    <script src="/bs-theme-mode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.min.js"></script>

  </head>
<body>
    <div class="col-lg-10 mx-auto p-3 py-md-5">
        <header class="d-flex align-items-center pb-3 mb-5 border-bottom">
          <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
            <h1>ytdlp2STRM - Settings</h1>
          </a>
        </header>
      
        <main>
          <div class="mb-5">
            <a href="/general" class="btn btn-primary btn-lg px-4">General Settings</a>
            <a href="/plugins" class="btn btn-primary btn-lg px-4">Enable / Disable Plugins</a>
            <a href="/crons" class="btn btn-primary btn-lg px-4">Enable / Disable CRONS</a>

          </div>
          <hr class="col-3 col-md-2 mb-5">

          <div class="row g-5">
            <div class="col-md-6">
              <h2>Plugins</h2>
              <ul class="icon-list">
                {% for value in plugins %}
                  <li class="text-muted">
                    <span class="badge bg-secondary">{{ value.name }}</span>
                    {% if value.enabled == True %}
                      <span class="badge bg-success">ENABLED</span>
                    {% else %}
                      <span class="badge bg-danger">DISABLED</span>
                    {% endif %}
                    <a href="/plugin/{{ value.name }}"><span class="badge bg-primary">Settings</span></a>
                    {% if value.channels != None %}
                      <a href="/plugin/{{ value.name }}/channels"><span class="badge bg-primary">Channels</span></a>
                    {% endif %}
                    <span style="cursor: pointer;" class="badge bg-danger play-btn" data-media-name="{{ value.name }}">Run</span>
                  </li>
                {% endfor %}
              </ul>
            </div>
      
            <div class="col-md-6">
              <h2>Crons</h2>
              <ul class="icon-list">
                {% for value in crons %}
                  <li class="text-muted">
                    <span class="badge bg-secondary">{{ value.do[1] }}</span> in <span class="badge bg-secondary">{{ value.do[3] }}</span> mode, every <span class="badge bg-secondary">{{ value.qty }} {{ value.every }}</span> 
                    {% if value.at != "" %}
                      at <span class="badge bg-secondary">{{ value.at }}h</span>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
            <div class="col-md-12">
              <h2>CLI</h2>
              <div id="terminal" style="background-color: black; color: white; padding: 10px; height: 300px; overflow-y: auto;">
                <!-- Aquí se mostrará el output y el input -->
              </div>  
            </div>
          </div>
        </main>
        <footer class="pt-5 my-5 text-muted border-top">
          <a href="https://github.com/fe80Grau/ytdlp2STRM" target="_blank"><i class="bi bi-github"></i> fe80grau / ytdlp2STRM</a>
          <a style="float:right" href="https://www.buymeacoffee.com/fe80grau" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="width: 90px !important;" ></a>
        </footer>
      </div>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
      <script>
        run_block = false;
        document.addEventListener('DOMContentLoaded', function() {

            const terminal = document.getElementById('terminal');
            const socket = io.connect('http://' + document.domain + ':' + location.port);
           

            //listener

            terminal.addEventListener('click', function() {
                // Asegurarte de que este es tu selector correcto para el input.
                const input = document.querySelector('#terminal .input-line input');
                if(input) {
                    input.focus();
                }
            });

            document.querySelectorAll('.play-btn').forEach(function(button) {
              button.addEventListener('click', function() {
                if(!run_block){
                  run_block = true;
                  const mediaName = this.getAttribute('data-media-name');
                  const command = `python cli.py --media ${mediaName} --params direct`;
                  
                  // Asume que esta función simula escribir el comando y presionar 'Enter'.
                  // Si no tienes una función como esta, tendrías que implementar una.
                  emitCommand(command);
                }else{
                  alert('Wait for the current run to finish.');
                }
              });
            });

            // Función modificada para agregar líneas de texto al terminal
            function addLine(text, isCommand=false) {
                const line = document.createElement('div');
                if(isCommand) {
                    const prompt = document.createElement('span');
                    prompt.textContent = '$ ';
                    line.appendChild(prompt);
                    const content = document.createElement('span');
                    content.textContent = text;
                    line.appendChild(content);
                } else {
                    line.textContent = text;
                }
                terminal.appendChild(line);
                
                // Realiza el scroll automático después de cada agregación
                terminal.scrollTop = terminal.scrollHeight;
            }
            
            // Función para gestionar la entrada de comandos
            function handleCommandInput() {
                const inputLine = document.createElement('div');
                inputLine.className = 'input-line';
                const prompt = document.createElement('span');
                prompt.textContent = '$ ';
                const input = document.createElement('input');
                input.type = 'text';
                inputLine.appendChild(prompt);
                inputLine.appendChild(input);
                terminal.appendChild(inputLine);
                input.focus();
                
                input.addEventListener('keydown', function(event) {
                    if(event.key === 'Enter' && input.value.trim() !== '') {
                        const command = input.value.trim();
                        socket.emit('execute_command', command);
                        
                        addLine(command, true); // Refleja el comando en el terminal
                        inputLine.remove(); // Asegúrate de remover el inputLine
                    }
                });
            }
            function emitCommand(command) {
              const input = document.querySelector('#terminal .input-line input');

              if(input) {
                // Establece el valor del comando en el input.
                input.value = command;
                
                // Crea un nuevo evento 'keydown' y configura 'key' como 'Enter'.
                let event = new KeyboardEvent('keydown', { key: 'Enter' });
                
                // Dispara el evento 'keydown' en el input.
                // Nota: Algunos navegadores pueden no permitir simular eventos de teclado de esta manera para acciones protegidas.
                input.dispatchEvent(event);
              }
            }

            // Escuchadores de eventos (listeners) de Socket.IO
            
            socket.on('connect', function() {
                // addLine("Connected to server.", false);
                // No necesitamos llamar a handleCommandInput() aquí puesto que se llama después de 'command_completed'
            });

            socket.on('command_output', function(msg) {
                addLine(msg, false); // Asegúrate de que 'msg' sea el mensaje en sí, sin envoltura {}
            });
            
            // Escucha para cuando un comando ha finalizado
            socket.on('command_completed', function() {
                run_block = false;
                handleCommandInput(); // Asegura que el input se vuelva a crear y esté listo para el siguiente comando
            });

            // Inicializa el primer prompt
            handleCommandInput(); 
        });


    </script>
</body>
</html>